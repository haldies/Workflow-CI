name: CI - Train ML Model

on:
  push:
    paths:
      - "MLProject/**"
      - ".github/workflows/ci.yml"

jobs:
  build-train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"

      - name: Check Env
        run: |
          python --version
          pip --version

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: mlflow-env
          environment-file: MLProject/conda.yaml
          auto-activate-base: false

      - name: Ensure mlruns is a clean directory
        run: |
          if [ -f "MLProject/mlruns" ]; then
            echo "⚠️ 'mlruns' is a file. Removing it so MLflow can create a directory."
            rm MLProject/mlruns
          fi

          if [ ! -d "MLProject/mlruns" ]; then
            mkdir -p MLProject/mlruns
          fi

      - name: Run MLflow Project
        shell: bash -l {0}
        run: |
          export MLFLOW_TRACKING_URI=file:MLProject/mlruns
          mlflow run MLProject --experiment-name titanic_experiment

      - name: List MLflow run directories (debug)
        run: |
          echo "🗂  Listing contents of MLProject:"
          ls -l MLProject || { echo "❌ Folder MLProject tidak ditemukan"; exit 1; }

          echo "🔍 Checking for mlruns folder in MLProject:"
          if [ -d "MLProject/mlruns" ]; then
            echo "✅ 'mlruns' directory exists. Listing contents recursively:"
            ls -R MLProject/mlruns
          else
            echo "⚠️ 'mlruns' directory not found. Mungkin MLflow belum membuat experiment/run?"
          fi

      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          EXPERIMENT_ID=$(mlflow experiments list | grep titanic_experiment | awk '{print $1}')
          echo "experiment_id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT

          RUN_ID=$(mlflow runs list --experiment-id $EXPERIMENT_ID --order-by attribute.start_time DESC --max-results 1 --output json | jq -r '.[0].info.run_id')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Upload mlruns to artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlruns
          path: MLProject/mlruns/${{ env.experiment_id }}/${{ env.MLFLOW_RUN_ID }}/artifacts

      - name: Upload to Google Drive (optional)
        if: false # Ubah ke true dan tambahkan skrip jika kamu butuh
        run: echo "Upload to Google Drive logic here..."

      - name: Build Docker Image from MLflow model
        run: |
          MODEL_PATH=MLProject/mlruns/0/${{ steps.get_run_id.outputs.run_id }}/artifacts/model
          echo "Model path: $MODEL_PATH"
          mlflow models build-docker -m $MODEL_PATH -n ${{ secrets.DOCKER_USERNAME }}/mlproject-image

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Tag Docker Image
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/mlproject-image ${{ secrets.DOCKER_USERNAME }}/mlproject-image:latest

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/mlproject-image:latest
